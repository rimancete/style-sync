```mermaid
graph TB
    %% External Layer
    subgraph External["üåê External Layer"]
        Client["Client Applications<br/>(React SPA)"]
        AdminClient["Admin Dashboard"]
    end

    %% Entry Point
    subgraph Bootstrap["üöÄ NestJS Bootstrap (main.ts)"]
        CORS["CORS Middleware<br/>(Origin validation)"]
        GlobalPrefix["Global Prefix<br/>(/api)"]
        StaticAssets["Static Assets<br/>(/uploads/)"]
        ValidationPipe["Global Validation Pipe<br/>(Transform, Whitelist)"]
        Swagger["Swagger Documentation<br/>(/api/docs)"]
    end

    %% Request Processing Pipeline
    subgraph Pipeline["üîÑ Request Processing Pipeline"]
        ThrottleG["ThrottlerGuard<br/>(Global Rate Limiting)<br/>60 req/min default"]
        ExceptionFilter["HttpExceptionFilter<br/>(Error Formatting)"]
        ResponseInterceptor["ResponseTransformInterceptor<br/>(Wrap responses in {data})"]
    end

    %% Controllers Layer
    subgraph Controllers["üéÆ Controller Layer"]
        subgraph PublicC["Public Endpoints"]
            HealthC["HealthController<br/>GET /health<br/>GET /health/database<br/>GET /health/detailed"]
            AuthC["AuthController<br/>POST /auth/login<br/>POST /auth/refresh"]
            CustomerAuthC["CustomerAuthController<br/>POST /salon/:slug/auth/register"]
            CustomerBrandingC["CustomersController<br/>GET /customers/branding/:slug"]
        end

        subgraph AdminC["Admin Endpoints (Global)"]
            AdminBranchC["BranchesController<br/>CRUD /branches"]
            AdminCountryC["CountriesController<br/>CRUD /countries"]
            AdminProfC["ProfessionalsController<br/>CRUD /professionals"]
        end

        subgraph CustomerC["Customer-Scoped Endpoints"]
            CSBranchC["CustomerBranchesController<br/>CRUD /salon/:slug/branches"]
            CSProfC["CustomerProfessionalsController<br/>CRUD /salon/:slug/professionals"]
            CSBranchProfC["CustomerBranchProfessionalsController<br/>GET /salon/:slug/branches/:id/professionals"]
            CustomerContextC["CustomersController<br/>GET /customers/context/:slug<br/>GET /customers/my-customers"]
        end
    end

    %% Security Layer
    subgraph Security["üîê Security Layer (Guards & Strategies)"]
        JWTGuard["JwtAuthGuard<br/>(Validates JWT token)"]
        JWTStrategy["JwtStrategy<br/>(Passport strategy)"]
        CustomerGuard["CustomerContextGuard<br/>(Resolves & validates customer)<br/>(Injects activeCustomerId)"]
        RolesGuard["RolesGuard<br/>(ADMIN/STAFF/CLIENT)"]
        CustomerAccessGuard["CustomerAccessGuard<br/>(Validates user-customer link)"]
        GlobalAdminGuard["GlobalAdminGuard<br/>(Admin-only operations)"]
        PublicDecorator["@Public()<br/>(Bypass authentication)"]
    end

    %% Service Layer
    subgraph Services["‚öôÔ∏è Service Layer (Business Logic)"]
        HealthS["HealthService"]
        AuthS["AuthService<br/>(JWT generation, validation)<br/>(Password hashing: bcrypt)<br/>(User-Customer linking)"]
        BranchS["BranchesService<br/>(Admin & customer-scoped ops)<br/>(Soft delete support)"]
        CountryS["CountriesService"]
        CustomerS["CustomersService<br/>(Branding management)<br/>(File upload handling)"]
        ProfS["ProfessionalsService<br/>(Photo uploads)<br/>(Branch association)"]
        FileS["FileService<br/>(Multer integration)<br/>(File validation)"]
    end

    %% Data Access Layer
    subgraph DataAccess["üíæ Data Access Layer"]
        DatabaseService["DatabaseService<br/>(extends PrismaClient)<br/>(Connection pool)<br/>(Health checks)"]
        PrismaClient["Prisma ORM<br/>(Type-safe queries)<br/>(Migrations)<br/>(Query logging)"]
    end

    %% Database Layer
    subgraph Database["üóÑÔ∏è PostgreSQL Database"]
        subgraph CoreTables["Core Tables"]
            User["users<br/>(id: CUID, displayId: Int)<br/>(email, password, role)"]
            Customer["customers<br/>(id: CUID, displayId: Int)<br/>(urlSlug: unique)<br/>(branding config)"]
            UserCustomer["user_customers<br/>(junction table)<br/>(userId, customerId)"]
        end

        subgraph BusinessTables["Business Tables"]
            Country["countries<br/>(code, name, addressFormat)"]
            Branch["branches<br/>(id: CUID, displayId: Int)<br/>(customerId, countryId)<br/>(deletedAt: soft delete)"]
            Professional["professionals<br/>(id: CUID, displayId: Int)<br/>(customerId, documentId)<br/>(photoUrl, isActive)"]
            ProfBranch["professional_branches<br/>(professionalId, branchId)"]
            Service["services<br/>(customerId, duration)"]
            ServicePricing["service_pricing<br/>(serviceId, branchId, price)"]
            Booking["bookings<br/>(userId, branchId, serviceId)<br/>(professionalId, status)"]
        end
    end

    %% Common Infrastructure
    subgraph Common["üîß Common Infrastructure"]
        Decorators["Decorators<br/>@Public, @Roles, @User<br/>@RateLimit, @CustomerBrandingUpload"]
        Filters["Filters<br/>HttpExceptionFilter"]
        Interceptors["Interceptors<br/>ResponseTransformInterceptor"]
        Pipes["Pipes<br/>ValidationPipe"]
        Utils["Utils<br/>CustomerUrlUtil<br/>(URL parsing & validation)"]
        Types["Types & Interfaces<br/>AuthenticatedUser<br/>ApiResponse"]
    end

    %% Configuration
    subgraph Config["‚öôÔ∏è Configuration"]
        ConfigModule["ConfigModule<br/>(Global)"]
        EnvVars["Environment Variables<br/>DATABASE_URL, JWT_SECRET<br/>JWT_REFRESH_SECRET<br/>SWAGGER_ENABLED"]
    end

    %% Data Flow Connections
    Client --> CORS
    AdminClient --> CORS
    CORS --> GlobalPrefix
    GlobalPrefix --> ThrottleG
    ThrottleG --> HealthC
    ThrottleG --> AuthC
    ThrottleG --> CustomerAuthC
    ThrottleG --> CustomerBrandingC
    ThrottleG --> AdminBranchC
    ThrottleG --> AdminCountryC
    ThrottleG --> AdminProfC
    ThrottleG --> CSBranchC
    ThrottleG --> CSProfC
    ThrottleG --> CSBranchProfC
    ThrottleG --> CustomerContextC

    %% Public endpoints
    HealthC --> HealthS
    AuthC --> PublicDecorator
    AuthC --> AuthS
    CustomerAuthC --> PublicDecorator
    CustomerAuthC --> AuthS
    CustomerBrandingC --> PublicDecorator
    CustomerBrandingC --> CustomerS

    %% Admin endpoints with guards
    AdminBranchC --> JWTGuard
    AdminBranchC --> RolesGuard
    AdminBranchC --> BranchS
    AdminCountryC --> JWTGuard
    AdminCountryC --> RolesGuard
    AdminCountryC --> CountryS
    AdminProfC --> JWTGuard
    AdminProfC --> GlobalAdminGuard
    AdminProfC --> ProfS

    %% Customer-scoped endpoints with guards
    CSBranchC --> JWTGuard
    CSBranchC --> CustomerGuard
    CSBranchC --> RolesGuard
    CSBranchC --> BranchS
    CSProfC --> JWTGuard
    CSProfC --> CustomerGuard
    CSProfC --> RolesGuard
    CSProfC --> ProfS
    CSBranchProfC --> JWTGuard
    CSBranchProfC --> CustomerGuard
    CSBranchProfC --> ProfS
    CustomerContextC --> JWTGuard
    CustomerContextC --> CustomerGuard
    CustomerContextC --> CustomerS

    %% Guard dependencies
    JWTGuard --> JWTStrategy
    JWTStrategy --> AuthS
    CustomerGuard --> DatabaseService
    CustomerGuard --> Utils

    %% Service to Data Access
    HealthS --> DatabaseService
    AuthS --> DatabaseService
    BranchS --> DatabaseService
    CountryS --> DatabaseService
    CustomerS --> DatabaseService
    CustomerS --> FileS
    ProfS --> DatabaseService
    ProfS --> FileS

    %% Data Access to Database
    DatabaseService --> PrismaClient
    PrismaClient --> User
    PrismaClient --> Customer
    PrismaClient --> UserCustomer
    PrismaClient --> Country
    PrismaClient --> Branch
    PrismaClient --> Professional
    PrismaClient --> ProfBranch
    PrismaClient --> Service
    PrismaClient --> ServicePricing
    PrismaClient --> Booking

    %% Database Relationships
    User -.-> UserCustomer
    Customer -.-> UserCustomer
    Customer -.-> Branch
    Customer -.-> Professional
    Customer -.-> Service
    Country -.-> Branch
    Branch -.-> Professional
    Branch -.-> ProfBranch
    Professional -.-> ProfBranch
    Service -.-> ServicePricing
    Branch -.-> ServicePricing
    Service -.-> Booking
    Branch -.-> Booking
    Professional -.-> Booking
    User -.-> Booking

    %% Response Flow
    HealthS --> ResponseInterceptor
    AuthS --> ResponseInterceptor
    BranchS --> ResponseInterceptor
    CountryS --> ResponseInterceptor
    CustomerS --> ResponseInterceptor
    ProfS --> ResponseInterceptor
    ResponseInterceptor --> Client
    ResponseInterceptor --> AdminClient
    ExceptionFilter --> Client
    ExceptionFilter --> AdminClient

    %% Configuration connections
    ConfigModule --> EnvVars
    EnvVars --> DatabaseService
    EnvVars --> JWTStrategy
    EnvVars --> Swagger

    %% Styling
    classDef external fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef security fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef service fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef data fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef controller fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef infrastructure fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class Client,AdminClient external
    class JWTGuard,JWTStrategy,CustomerGuard,RolesGuard,CustomerAccessGuard,GlobalAdminGuard,PublicDecorator security
    class HealthS,AuthS,BranchS,CountryS,CustomerS,ProfS,FileS service
    class DatabaseService,PrismaClient,User,Customer,UserCustomer,Country,Branch,Professional,ProfBranch,Service,ServicePricing,Booking data
    class HealthC,AuthC,CustomerAuthC,CustomerBrandingC,AdminBranchC,AdminCountryC,AdminProfC,CSBranchC,CSProfC,CSBranchProfC,CustomerContextC controller
    class Decorators,Filters,Interceptors,Pipes,Utils,Types,ConfigModule infrastructure
```